var magic={common:{},config:{paths:{baseurl:(window.location.origin||window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""))+"/helpdesk",cdn:"https://cdn.web.bas.ac.uk/magic"}},classes:{},runtime:{pingSession:function(){jQuery.get(magic.config.paths.baseurl+"/ping")},showAlertModal:function(a,b){a=a||"An unspecified error occurred",b=b||"error";var c=b,d="margin-bottom:0";"error"==b&&(c="danger",d="margin-top:10px"),bootbox.hideAll(),bootbox.alert('<div class="alert alert-'+c+'" style="'+d+'">'+("error"==b?"<p>An error occurred - more details below:</p>":"")+"<p>"+a+"</p></div>")}}};setInterval("magic.runtime.pingSession()",3e6),magic.classes.AoiPanel=function(){this.prefix="helpdesk-aoi",this.formGen={map:{antarctica:new formwidgets.classes.FormGenerator([{field:"antarctica",type:"mapaoi",required:!1,region:"antarctica",container:this.prefix+"-map-antarctica",width:"100%",height:"80%"}]),arctic:new formwidgets.classes.FormGenerator([{field:"arctic",type:"mapaoi",required:!1,region:"arctic",container:this.prefix+"-map-arctic",width:"100%",height:"80%"}]),southgeorgia:new formwidgets.classes.FormGenerator([{field:"southgeorgia",type:"mapaoi",required:!1,region:"southgeorgia",container:this.prefix+"-map-southgeorgia",width:"100%",height:"80%"}]),midlatitudes:new formwidgets.classes.FormGenerator([{field:"midlatitudes",type:"mapaoi",required:!1,region:"midlatitudes",container:this.prefix+"-map-midlatitudes",width:"100%",height:"80%"}])},corners:new formwidgets.classes.FormGenerator([{field:"corners",type:"boundingbox",title:"Bounding box",required:!1,wkt:!0}]),lat:new formwidgets.classes.FormGenerator([{field:"lat",type:"text",title:"Bounding latitude",tooltip:"Bounding latitude, decimal degrees, DD MM SS.SSH or HDD MM.MM",required:!1}]),description:new formwidgets.classes.FormGenerator([{field:"description",type:"textarea",title:"Description",tooltip:"Enter as full a description of the area covered by your request as you can",required:!1}])},this.formGen.map.antarctica.markup(jQuery("#"+this.prefix+"-map-antarctica"),""),this.aoiMethod="map",this.selectedMap="antarctica",jQuery("a[data-toggle='tab']").filter("[href^='#"+this.prefix+"-map']").on("shown.bs.tab",function(a){var b=a.target.hash.replace("#"+this.prefix+"-map-","");this.formGen.map[b].isMarkedUp()||this.formGen.map[b].markup(jQuery("#"+this.prefix+"-map-"+b),""),this.selectedMap=b,this.formGen.map[b].inputs[0].refresh()}.bind(this)),jQuery("a[data-toggle='tab']").filter("[href^='#"+this.prefix+"-method']").on("shown.bs.tab",function(a){this.aoiMethod=a.target.hash.replace("#"+this.prefix+"-method-",""),"map"==this.aoiMethod||"na"==this.aoiMethod||this.formGen[this.aoiMethod].isMarkedUp()||this.formGen[this.aoiMethod].markup(jQuery("#"+this.prefix+"-"+this.aoiMethod+"-panel"),this.prefix)}.bind(this))},magic.classes.AoiPanel.prototype.getValue=function(){var a={};switch(this.aoiMethod){case"map":var b=this.formGen.map[this.selectedMap].getValue();a[this.prefix+"-area"]=b[this.selectedMap];break;case"corners":var c=this.formGen.corners.getValue()[this.prefix+"-"+this.aoiMethod];a[this.prefix+"-area"]=null==c?[]:[c];break;case"lat":var c=this.aoiFromLat(this.formGen.lat.getValue());a[this.prefix+"-area"]=null==c?[]:[c];break;default:a[this.prefix+"-area"]=[]}var d=jQuery("#"+this.prefix+"-description");return a[this.prefix+"-description"]=d.length>0?d.val():"",a},magic.classes.AoiPanel.prototype.validate=function(){var a=!1,b=this.getValue();switch(this.aoiMethod){case"map":case"corners":case"lat":a=b[this.prefix+"-area"].length>0;break;case"description":a=""!=b[this.prefix+"-description"];default:a=!0}return a},magic.classes.AoiPanel.prototype.aoiFromLat=function(){var a=null,b=jQuery("#"+this.prefix+"-lat"),c=ol.coordinate.toFloatDD(b.val(),!0),d=ol.coordinate.isValid([0,c]);return new formwidgets.classes.ValidationStatus(b,d,"Coordinate is invalid",!0).setFeedback(),d&&(a=c<0?ol.extent.toWktPolygon([-180,-90,180,c]):ol.extent.toWktPolygon([-180,c,180,90])),a},magic.classes.DetailsPanel=function(){this.formGen=new formwidgets.classes.FormGenerator([{field:"name",type:"text",title:"Your name",tooltip:"Enter your name",required:!0,minlength:5},{field:"email",type:"text",subtype:"email",title:"Contact email",tooltip:"Enter a valid email address",required:!0},{field:"phone",type:"text",title:"Phone number",tooltip:"Your phone/extension number (optional)",required:!1},{field:"requiredby",type:"datetimepicker",title:"Required by",tooltip:"When we need to have completed this task by",required:!0,format:"DD/MM/YYYY",viewmode:"days",rangevalidator:function(a){var b=moment(a.val(),this.format).toDate(),c=""==a.val()||Date.parse(b)-Date.now()>0;return c||a[0].setCustomValidity("Required by date must be in the future"),c}}]),this.formGen.markup(jQuery("#helpdesk-details-panel"),"helpdesk-details")},magic.classes.DetailsPanel.prototype.getValue=function(){return this.formGen.getValue()},magic.classes.DetailsPanel.prototype.validate=function(){return this.formGen.validate()},magic.classes.HelpdeskPanel=function(){this.panels={details:new magic.classes.DetailsPanel,other:new magic.classes.OtherInformationPanel,aoi:new magic.classes.AoiPanel},jQuery("#helpdesk-form-go").click(this.submitRequest.bind(this))},magic.classes.HelpdeskPanel.prototype.validate=function(){return this.panels.details.validate()&&this.panels.aoi.validate()&&this.panels.other.validate()},magic.classes.HelpdeskPanel.prototype.getValue=function(){return jQuery.extend({},this.panels.details.getValue(),this.panels.aoi.getValue(),this.panels.other.getValue())},magic.classes.HelpdeskPanel.prototype.submitRequest=function(){if(this.validate()){console.log("Submitting request...");var a=this.getValue(),b=this.panels.other.getPopulatedDropzone();null!=b?(console.log("Attachment(s) submitted for upload - go through dropzone 'sendingmultiple' event handler"),b.on("sendingmultiple",function(b,c,d){jQuery.each(a,function(a,b){console.log("Appending "+a+" : "+b),d.append(a,b)})}),b.processQueue()):(console.log("No uploads required : do as straight AJAX"),jQuery.ajax({url:magic.config.paths.baseurl+"/add_issue",data:JSON.stringify(a),method:"POST",dataType:"json",contentType:"application/json"}).done(function(){window.location=magic.config.paths.baseurl+"/thankyou"}).fail(function(a){magic.runtime.showAlertModal("Request submission failed - details: "+JSON.parse(a.responseText).detail,"error")}))}else magic.runtime.showAlertModal("Please correct any errors indicated and try again. In particular, have you remembered to specify your area of interest?","error")},magic.classes.OtherInformationPanel=function(){this.formGen=new formwidgets.classes.FormGenerator([{field:"details",type:"textarea",defval:"What outputs do you require and what is the output to be used for?\nIf the request is for a map, how much detail/data would you like shown?\nApproximately what size would you like the map to be?\nUpload any additional attachments below",title:"Please specify",tooltip:"List any other relevant details of your request here",required:!0,height:10},{field:"attachments",type:"fileupload",title:"Attachments",url:magic.config.paths.baseurl+"/add_issue",required:!1,onsave:function(){window.location=magic.config.paths.baseurl+"/thankyou"}}]),this.formGen.markup(jQuery("#helpdesk-other-panel"),"helpdesk-other"),jQuery("#helpdesk-other-details").click(function(){this.focus(),this.select()})},magic.classes.OtherInformationPanel.prototype.getValue=function(){return this.formGen.getValue()},magic.classes.OtherInformationPanel.prototype.validate=function(){return this.formGen.validate()},magic.classes.OtherInformationPanel.prototype.getPopulatedDropzone=function(){return this.formGen.getFirstPopulatedDropzone()};